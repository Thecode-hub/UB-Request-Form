<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Analyses</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="ori-header">
    <div class="header-left">
      <p>
        <strong>Okavango Research Institute</strong><br>
        Shorobe Road, Sexaxa, Maun<br>
        Pvt Bag 285, Maun, Botswana<br>
        Tel: (267) 681 7200 | Fax: (267) 680 1835<br>
        Email: directorori@ori.ub.bw
      </p>
    </div>
    <img src="assets/logo.png" class="logo-top-right" alt="ORI Logo" />
  </header>

  <main>
    <img src="assets/logo.png" class="logo-center" alt="ORI Logo Center" />
    <h2>Analysis Checklist</h2>

    <form id="analysisForm">
      <fieldset>
        <legend>Water and Wastewater</legend>
        <label><input type="checkbox" name="analysis" value="pH" /> pH</label>
        <label><input type="checkbox" name="analysis" value="Turbidity" /> Turbidity</label>
        <label><input type="checkbox" name="analysis" value="DO" /> Dissolved Oxygen</label>
        <label><input type="checkbox" name="analysis" value="EC" /> Electrical Conductivity</label>
        <label><input type="checkbox" name="analysis" value="TDS" /> Total Dissolved Solids</label>
        <label><input type="checkbox" name="analysis" value="Alkalinity" /> Alkalinity</label>
        <label><input type="checkbox" name="analysis" value="Hardness" /> Hardness</label>
        <label><input type="checkbox" name="analysis" value="TDS" />Total Dissolved Solis </label>
        <label><input type="checkbox" name="analysis" value="TDC" /> Total Dissolved Carbon</label>
        <label><input type="checkbox" name="analysis" value="TOC" /> Total Organic Carbon</label>
        <label><input type="checkbox" name="analysis" value="Total Nitrogen" /> Total Nitrogen</label>
        <label><input type="checkbox" name="analysis" value="Total Phosphorus" /> Total Phosphorus</label>
        <label><input type="checkbox" name="analysis" value="Sodium" /> Sodium</label>
        <label><input type="checkbox" name="analysis" value="Potassium" /> Potassium</label>
        <label><input type="checkbox" name="analysis" value="Calcium" /> Calcium </label>
        <label><input type="checkbox" name="analysis" value="Magnesium" /> Magnesium</label>
        <label><input type="checkbox" name="analysis" value="Aluminium" /> Aluminium</label>
        <label><input type="checkbox" name="analysis" value="Barium" /> Barium</label>
        <label><input type="checkbox" name="analysis" value="Beryllium" /> Beryllium</label>
        <label><input type="checkbox" name="analysis" value="Boron " /> Boron </label>
        <label><input type="checkbox" name="analysis" value="Cadmium" /> Cadmium </label>
        <label><input type="checkbox" name="analysis" value="Chromium" /> Chromium </label>
        <label><input type="checkbox" name="analysis" value="Cobalt" /> Cobalt </label>
        <label><input type="checkbox" name="analysis" value="Copper" /> Copper </label>
        <label><input type="checkbox" name="analysis" value="Iron" /> Iron </label>
        <label><input type="checkbox" name="analysis" value="Lead" /> Lead </label>
        <label><input type="checkbox" name="analysis" value="Manganese" /> Manganese </label>
        <label><input type="checkbox" name="analysis" value="Mercury" /> Mercury </label>
        <label><input type="checkbox" name="analysis" value="Molybdenum" /> Molybdenum </label>
        <label><input type="checkbox" name="analysis" value="Nickel" /> Nickel </label>
        <label><input type="checkbox" name="analysis" value="Silicon" /> Silicon </label>
        <label><input type="checkbox" name="analysis" value="Strontium" /> Strontium </label>
        <label><input type="checkbox" name="analysis" value="Vanadium" /> Vanadium </label>
        <label><input type="checkbox" name="analysis" value="Zinc" /> Zinc </label>
        <label><input type="checkbox" name="analysis" value="Arsenic" /> Arsenic </label>
        <label><input type="checkbox" name="analysis" value="Selenium" /> Selenium </label>
        <label><input type="checkbox" name="analysis" value="Total Coliforms" /> Total Coliforms </label>
        <label><input type="checkbox" name="analysis" value="Faecal Coliforms" /> Faecal Coliforms </label>
        <label><input type="checkbox" name="analysis" value="Faecal Streptococci" /> Faecal Streptococci </label>
        <label><input type="checkbox" name="analysis" value="Anions" /> Anions </label>
        <label><input type="checkbox" name="analysis" value="BOD" /> BOD </label>
        <label><input type="checkbox" name="analysis" value="COD" /> COD </label>
      </fieldset>

      <fieldset>
        <legend>Soil Analysis</legend>
        <label><input type="checkbox" name="analysis" value="Nitrogen" /> Nitrogen</label>
        <label><input type="checkbox" name="analysis" value="Organic Matter" /> Organic Matter</label>
        <label><input type="checkbox" name="analysis" value="Sodium" /> Sodium </label>
        <label><input type="checkbox" name="analysis" value="Potassium" /> Potassium </label>
        <label><input type="checkbox" name="analysis" value="Calcium" /> Calcium </label>
        <label><input type="checkbox" name="analysis" value="Magnesium" /> Magnesium </label>
        <label><input type="checkbox" name="analysis" value="Aluminium" /> Aluminium </label>
        <label><input type="checkbox" name="analysis" value="Barium" /> Barium </label>
        <label><input type="checkbox" name="analysis" value="Beryllium" /> Beryllium </label>
        <label><input type="checkbox" name="analysis" value="Boron" /> Boron </label>
        <label><input type="checkbox" name="analysis" value="Cadmium" /> Cadmium </label>
        <label><input type="checkbox" name="analysis" value="Chromium" /> Chromium </label>
        <label><input type="checkbox" name="analysis" value="Cobalt" /> Cobalt </label>
        <label><input type="checkbox" name="analysis" value="Copper" /> Copper </label>
        <label><input type="checkbox" name="analysis" value="Iron" /> Iron </label>
        <label><input type="checkbox" name="analysis" value="Lead" /> Lead </label>
        <label><input type="checkbox" name="analysis" value="Manganese" /> Manganese </label>
        <label><input type="checkbox" name="analysis" value="Mercury" /> Mercury </label>
        <label><input type="checkbox" name="analysis" value="Molybdenum" /> Molybdenum </label>
        <label><input type="checkbox" name="analysis" value="Nickel" /> Nickel </label>
        <label><input type="checkbox" name="analysis" value="Silicon" /> Silicon </label>
        <label><input type="checkbox" name="analysis" value="Strontium" /> Strontium </label>
        <label><input type="checkbox" name="analysis" value="Vanadium" /> Vanadium </label>
        <label><input type="checkbox" name="analysis" value="Zinc" /> Zinc </label>
        <label><input type="checkbox" name="analysis" value="Arsenic" /> Arsenic </label>
        <label><input type="checkbox" name="analysis" value="Selenium" /> Selenium </label>
        <label><input type="checkbox" name="analysis" value="TOC" /> Total Organic Carbon</label>
        <label><input type="checkbox" name="analysis" value="Total Nitrogen" /> Total Nitrogen</label>
        <label><input type="checkbox" name="analysis" value="Total Phosphorus" /> Total Phosphorus</label>
        <label><input type="checkbox" name="analysis" value="C" /> C </label>
        <label><input type="checkbox" name="analysis" value="H" /> H </label>
        <label><input type="checkbox" name="analysis" value="N" /> N </label>
        <label><input type="checkbox" name="analysis" value="S" /> S </label>
        <label><input type="checkbox" name="analysis" value="Sulphur" /> Sulphur </label>
        <label><input type="checkbox" name="analysis" value="Available Phosphorus" /> Available Phosphorus </label>
        <label><input type="checkbox" name="analysis" value="CEC Calcium" /> CEC Calcium </label>
        <label><input type="checkbox" name="analysis" value="CEC Magnesium" /> CEC Magnesium </label>
        <label><input type="checkbox" name="analysis" value="CEC Sodium" /> CEC Sodium </label>
        <label><input type="checkbox" name="analysis" value="CEC Potassium" /> CEC Potassium </label>
      </fieldset>

      <fieldset>
        <legend>Plant Analysis</legend>
        <label><input type="checkbox" name="analysis" value="Total Phosphorus" /> Total Phosphorus</label>
        <label><input type="checkbox" name="analysis" value="Chlorophyll" /> Chlorophyll</label>
        <label><input type="checkbox" name="analysis" value="Moisture Content" /> Moisture Content</label>
        <label><input type="checkbox" name="analysis" value="Total Organic Carbon (TOC)" /> Total Organic Carbon (TOC)
        </label>
        <label><input type="checkbox" name="analysis" value="Total Nitrogen" /> Total Nitrogen</label>
        <label><input type="checkbox" name="analysis" value="LOI" /> Loss On ignition</label>
        <label><input type="checkbox" name="analysis" value="Potassium" /> Potassium </label>
        <label><input type="checkbox" name="analysis" value="Calcium" /> Calcium </label>
        <label><input type="checkbox" name="analysis" value="Magnesium" /> Magnesium </label>
        <label><input type="checkbox" name="analysis" value="Aluminium" /> Aluminium </label>
        <label><input type="checkbox" name="analysis" value="Barium" /> Barium </label>
        <label><input type="checkbox" name="analysis" value="Beryllium" /> Beryllium </label>
        <label><input type="checkbox" name="analysis" value="Boron" /> Boron </label>
        <label><input type="checkbox" name="analysis" value="Cadmium" /> Cadmium </label>
        <label><input type="checkbox" name="analysis" value="Chromium" /> Chromium </label>
        <label><input type="checkbox" name="analysis" value="Cobalt" /> Cobalt </label>
        <label><input type="checkbox" name="analysis" value="Copper" /> Copper </label>
        <label><input type="checkbox" name="analysis" value="Iron" /> Iron </label>
        <label><input type="checkbox" name="analysis" value="Lead" /> Lead </label>
        <label><input type="checkbox" name="analysis" value="Manganese" /> Manganese </label>
        <label><input type="checkbox" name="analysis" value="Mercury" /> Mercury </label>
        <label><input type="checkbox" name="analysis" value="Molybdenum" /> Molybdenum </label>
        <label><input type="checkbox" name="analysis" value="Nickel" /> Nickel </label>
        <label><input type="checkbox" name="analysis" value="Silicon" /> Silicon </label>
        <label><input type="checkbox" name="analysis" value="Strontium" /> Strontium </label>
        <label><input type="checkbox" name="analysis" value="Vanadium" /> Vanadium </label>
        <label><input type="checkbox" name="analysis" value="Zinc" /> Zinc </label>
        <label><input type="checkbox" name="analysis" value="Arsenic" /> Arsenic </label>
        <label><input type="checkbox" name="analysis" value="Selenium" /> Selenium </label>
        <label><input type="checkbox" name="analysis" value="C" /> C </label>
        <label><input type="checkbox" name="analysis" value="H" /> H </label>
        <label><input type="checkbox" name="analysis" value="N" /> N </label>
        <label><input type="checkbox" name="analysis" value="S" /> S </label>
        <label><input type="checkbox" name="analysis" value="Sulphur" /> Sulphur </label>
      </fieldset>

      <label for="specialInstructions">Special Instructions:</label>
      <textarea id="specialInstructions" name="specialInstructions"
        placeholder="Any special instructions for the lab"></textarea>

      <label for="authorisation">Customer Authorisation:</label>
      <input type="text" id="authorisation" name="authorisation" placeholder="Customer name for authorisation"
        required />

      <label for="invoiceDate">Invoice Date:</label>
      <input type="date" id="invoiceDate" name="invoiceDate" required />

      <label for="releaseDate">Expected Release Date:</label>
      <input type="date" id="releaseDate" name="releaseDate" required />

      <div class="form-buttons">
        <button type="button" id="backBtn">Back</button>
        <button type="submit">Next</button>
      </div>
    </form>
  </main>

  <script type="module">
    import { db, doc, updateDoc, getDoc } from './js/firebase.js';

    const form = document.getElementById('analysisForm');
    const backBtn = document.getElementById('backBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";

        const checkedAnalyses = Array.from(document.querySelectorAll('input[name="analysis"]:checked'))
          .map(checkbox => checkbox.value);

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.analyses = checkedAnalyses;
        data.timestamp = new Date().toISOString();

        const requestId = localStorage.getItem("currentRequestId");
        if (!requestId) {
          throw new Error("No request found. Please start from the beginning.");
        }

        const docRef = doc(db, "labRequests", requestId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          throw new Error("Request document not found. Please create a new request first.");
        }

        await updateDoc(docRef, {
          analysisChecklist: data,
          status: "Analyses Selected"
        });

        window.location.href = "review-submission.html";
      } catch (error) {
        alert(`Error: ${error.message}\n\nPlease ensure you've completed all previous steps.`);
        console.error("Error saving analysis checklist:", error);

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = "Next";
      }
    });

    backBtn.addEventListener('click', () => {
      window.location.href = "sample-details.html";
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('invoiceDate').value = today;

      const releaseDate = new Date();
      releaseDate.setDate(releaseDate.getDate() + 14);
      document.getElementById('releaseDate').value = releaseDate.toISOString().split('T')[0];

      const requestId = localStorage.getItem("currentRequestId");
      if (requestId) {
        try {
          const docRef = doc(db, "labRequests", requestId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists() && docSnap.data().analysisChecklist) {
            const checklist = docSnap.data().analysisChecklist;

            if (checklist.analyses) {
              checklist.analyses.forEach(analysis => {
                const checkbox = document.querySelector(`input[name="analysis"][value="${analysis}"]`);
                if (checkbox) checkbox.checked = true;
              });
            }

            if (checklist.specialInstructions) {
              document.getElementById('specialInstructions').value = checklist.specialInstructions;
            }
            if (checklist.authorisation) {
              document.getElementById('authorisation').value = checklist.authorisation;
            }
            if (checklist.invoiceDate) {
              document.getElementById('invoiceDate').value = checklist.invoiceDate;
            }
            if (checklist.releaseDate) {
              document.getElementById('releaseDate').value = checklist.releaseDate;
            }
          }
        } catch (error) {
          console.error("Error loading existing analysis checklist:", error);
        }
      }
    });
  </script>
</body>
</html>